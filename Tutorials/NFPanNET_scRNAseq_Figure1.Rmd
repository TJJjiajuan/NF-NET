---
title: "NF-PanNET Figure 1"
author: "Jia-Juan Tu"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: united
date: "`r Sys.Date()`"
---

## Import library
```{r message=FALSE, warning=FALSE}
#remove(list= ls())
library(Seurat)
library(RColorBrewer)
library(ggplot2)
library(ggthemes)
library(scatterpie)
library(cowplot)
library(gridExtra)
library(viridis)
library(rstatix)
library(RColorBrewer)
library(stringr)
require(dplyr)
library(rcompanion)
library(ggpubr)

```


# Define colors for cell types
```{r}
colPar <- c("#B44145","#983C90","#565FAD","#3983C0","#6AB9D8","#227046","#98B660","#DBD177","#CEAC3B","#D68141","#897738","#905F31")

colParList = list(
  Lymphoid=c( "T cell"= colPar[1],"B cell"= colPar[2],
              "NKT cell"= colPar[3], "Proliferative Plasma cell"=colPar[4]),
  Endothelial=c("Artery"=colPar[1], "Capillary"=colPar[2], "Venous"=colPar[3]),
  Epithelial=c("Acinar"=colPar[4], "Ductal"=colPar[5]),
  Mesenchyme= c("iCAF"=colPar[1], "myCAF"= colPar[2], "stellate"=colPar[3]),
  Myeloid=c("Mast"=colPar[3], "MDSC"=colPar[4], "TAM"=colPar[5]),
  Endocrine =c("0" = colPar[1],"1" = colPar[2],"2" = colPar[3],
               "3" = colPar[4],"4" = colPar[5],"5" = colPar[6],
               "6" = colPar[7],"7" = colPar[8],"8" = colPar[9]
  ))


```

# Load data for 10 samples.
```{r warning=FALSE}

obj_merged <- readRDS("./Data/10Patients_merged_fastmnn_annotation_16types.rds")

dim(obj_merged )
#check the samples names
table(obj_merged @meta.data$orig.ident)

#check cell type type information with six major cell types
table(obj_merged@meta.data$sc_integ_cell_label_major)

#check grade information
table(obj_merged@meta.data$G123)

table(obj_merged@meta.data$subcluster)

## get the major cell types
lable_major = unique(obj_merged@meta.data$sc_integ_cell_label_major)
lable_major = lable_major[order(lable_major)]
lable_major

```



# Draw all sub figures for the main figure 1

## Draw the figure1 B 
**Note**: Heatmap for all cells types
```{r message=FALSE, warning=FALSE, paged.print=FALSE}

## read reference information
markerAndSubcluster <- read.csv("./Data/HeapmapOrder_FastMNN_figure1.csv")

markers = markerAndSubcluster$cell_marker[markerAndSubcluster$cell_marker!=""]
cell_sub_type = markerAndSubcluster$subcluster[markerAndSubcluster$subcluster!=""]

markers = intersect(markers, rownames(obj_merged))
Exp_MarkerBySubcluster <- sapply(levels(obj_merged$subcluster), function(x) rowMeans(obj_merged@assays$RNA@data[markers, obj_merged$subcluster==x]))

Exp_MarkerBySubcluster_norm1 <- t(apply(Exp_MarkerBySubcluster,1, function(x) (x-mean(x))/sd(x)))
Exp_MarkerBySubcluster_norm2 <- t(apply(Exp_MarkerBySubcluster,1, function(x) (x-min(x))/(max(x)-min(x))))

df1 <- as.data.frame.table(Exp_MarkerBySubcluster_norm1)

colnames(df1) <- c("Marker", "Subtype", "NormalizedExpression")

df1$Subtype = factor(df1$Subtype, levels=rev(levels(df1$Subtype)))

df2 <- as.data.frame.table(Exp_MarkerBySubcluster_norm2)
colnames(df2) <- c("Marker", "Subtype", "NormalizedExpression")

od_level = cell_sub_type#[c(1,2,4,3,8,9,10,11,12,5,6,7,13,14,15,16)]
od_level 
df2$Subtype = factor(df2$Subtype, levels = rev(od_level))


# finally we use df2 as the normalization method
heatmap_fig = ggplot(df2, aes(x=Marker, y=Subtype, fill=NormalizedExpression)) + geom_tile() +
  theme_bw() +
  scale_fill_viridis() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90,hjust=1, size=8), #angle = 45,
        axis.text.y = element_text(hjust=1, size=10))

heatmap_fig 

ggsave(heatmap_fig , file='./Figure/sapmles_marker_heatmap_Fig1b.pdf',width = 16, height = 12)    

```


## Figure 1-c: UMAP for all 10 samples of all cells
```{r}

col_df_celltype = data.frame(celltypes = lable_major,
                             col_vector = colPar[1:length(lable_major)])

fsample_allcell = DimPlot(obj_merged, group.by =c("sc_integ_cell_label_major")) + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank()) + 
  xlab("UMAP 1") + ylab("UMAP 2") + ggtitle("All cells")+
  scale_color_manual(values = col_df_celltype$col_vector,
                     breaks = col_df_celltype$celltypes) 

fsample_allcell 

ggsave(fsample_allcell, file='./Figure/10_sapmles_allcells_umap_Fig1c.pdf',width = 7, height = 5) 	

```

## Figure 1-d: UMAP the subcluster (fine-grain) for each cell type.
```{r message=FALSE, warning=FALSE}

cell_type_uni = c("Endothelial", "Epithelial", "Mesenchyme", "Myeloid", "Lymphoid")
cell_type_uni 

p_sub = matrix(list(),length(cell_type_uni) ,1)

for(i in 1:length(cell_type_uni)){
  
  print(cell_type_uni [i])
  
  obj = obj_merged[,obj_merged@meta.data$sc_integ_cell_label_major %in% cell_type_uni [i]]
  
  obj <- RunUMAP(obj, reduction="mnn", dims=1:30)
  ## or we can load all data for each cell types
  # obj = readRDS( paste0("./Data/subres/",cell_type_uni[i],"_fastMNN_Subcluster_anno.rds"))
  
  p_sub[[i]]<- DimPlot(obj, group.by = c("subcluster"), cols= colPar) + 
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          rect = element_blank()) + 
    xlab("UMAP 1") + ylab("UMAP 2") +ggtitle(cell_type_uni[i])
  
  #each figure
  file_name = paste0('./Figure/10_sapmles_umap_',cell_type_uni[i],'_Fig1d.pdf')
  ggsave( p_sub[[i]], file= file_name,width =6, height = 3) 
  
}


ff_sub = plot_grid(plotlist = p_sub, ncol=3)
ff_sub

ggsave( ff_sub, file='./Figure/10_sapmles_umap_allsub_Fig1d.pdf',width =12, height = 6) 

```



## Cell type proportion and significant hypotheses test  
**Note**: Here we group samples with three groups, G1, G2, and G3, and use the two-sided, same variance t-test to test distribution difference for each sub-cell type.
### First exclude endocrine cells
```{r}
### load cells and annotation

AllExceptEndocrine <- obj_merged[,obj_merged$subcluster!="Endocrine"]

dim(AllExceptEndocrine )

## remove endocrines cells
AllExceptEndocrine$subcluster = droplevels(factor(AllExceptEndocrine$subcluster, 
                                                  levels=unique(AllExceptEndocrine$subcluster)))


subcluster_inf = AllExceptEndocrine@meta.data[,c("G123","orig.ident","subcluster")]


## check the all samples
table(AllExceptEndocrine$subcluster)[sort(names(table(AllExceptEndocrine$subcluster)))]


```


### Second perform t.test with boxplot 
```{r warning=FALSE}
## all cells in each samples

cells = matrix(table(obj_merged @meta.data$orig.ident))

df_cont = subcluster_inf  %>%
  group_by(orig.ident,subcluster) %>%
  summarise(Freq = n()) %>%
  xtabs(formula = Freq ~ ., data = .)


datas1 = as.matrix(df_cont/c(cells))
rownames(datas1)


p.val_1 = p.val_2 = p.val_3 = c()
for(i in 1:ncol(datas1)){
  
  
  x1 = datas1[1:5,i]
  x2 = datas1[6:7,i]
  x3 = datas1[8:10,i]
  
  p.val_1 = c(p.val_1 ,t.test(x=x1, y=x2,alternative = "two.sided",var.equal = TRUE)$p.value)
  p.val_2 = c(p.val_2 ,t.test(x=x1, y=x3,alternative = "two.sided",var.equal = TRUE)$p.value)
  p.val_3 = c(p.val_3 ,t.test(x=x2, y=x3,alternative = "two.sided",var.equal = TRUE)$p.value)
}
p.val  = cbind(p.val_1,p.val_2,p.val_3)
rownames( p.val ) = colnames(datas1)
colnames( p.val ) = c("G1 VS G2","G1 VS G3","G2 VS G3")

p.val 

#write.csv(p.val, file='./Figure1/count_prop_box_per_celltype_ttest_threegroup.csv') 


```


## boxplot and add the p values
```{r}

order_ind = c("T cell","NKT cell","B cell","Proliferative Plasma cell","Mast", "MDSC",
              "TAM","Artery","Venous","Capillary","Ductal","Acinar","stellate","myCAF",
              "iCAF")


cont_mat_prop = data.frame(prop = c(as.matrix(datas1 )),
                           sample = rep(rownames(datas1), ncol(datas1 )),
                           subtype = factor(rep(colnames(datas1 ), each = nrow(datas1)),
                                            levels =  order_ind))

cont_mat_prop$grade = rep(rep (c("G1","G2","G3"),c(5,2,3)),ncol(datas1 ))


count_prop_box =  ggplot(cont_mat_prop, aes(x= factor( subtype,levels = order_ind ), y=prop , fill=grade)) +
  geom_boxplot( )+
  ylab("Average frequency of total cell clusters \n in each sample cluster") +  xlab("Cell subtypes")+ ggtitle("")+  
  scale_fill_manual(values = colPar)+
  theme_bw() +
  labs(fill="Grade") +
  theme(axis.line = element_line(colour = "black"),
        axis.text.x.bottom = element_text(size = 10,hjust = 1,angle = 45), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5))

count_prop_box

ggsave( count_prop_box , file='./Figure/10_sapmles_count_prop_box_per_celltype_Fig1h.pdf',width = 7, height = 5) 

```


# sessionInfo
```{r}
sessionInfo()
```
